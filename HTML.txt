<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ç©ºé–“è¨­è¨ˆå°è¦½æ–‡æ¡ˆå°å¹«æ‰‹</title>
  <style>
    body { font-family: sans-serif; background: #fffbea; padding: 20px; }
    .card { background: #fff8e1; padding: 20px; border-radius: 12px; box-shadow: 2px 2px 10px rgba(0,0,0,0.1); }
    label { font-weight: bold; }
    input, select, textarea { width: 100%; padding: 8px; margin: 5px 0 15px 0; border-radius: 6px; border: 1px solid #ccc; }
    button {
      background-color: #ffcc80;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 12px;
    }
    button:hover { background-color: #ffb74d; }
    img { max-width: 160px; margin-right: 12px; display: block; }
    .preview-block { background: #fff3e0; padding: 10px; margin-top: 10px; border-radius: 6px; white-space: pre-wrap; }
    .row-flex { display: flex; align-items: flex-end; gap: 16px; margin-bottom: 15px; }
    .table-edit-btn { padding: 3px 10px; background: #ffe0b2; border: 1px solid #e0a96d; border-radius: 5px; }
    .table-edit-btn:hover { background: #ffb74d; }
    .btn-col { margin: 36px 0 16px 0; display: flex; flex-direction: column; gap: 22px; }
    .add-space-btn-wrap { width: auto; align-self: flex-start; }
    .add-space-btn { width: auto; min-width: 90px; max-width: 180px; }
    .desc-tips { font-size: 16px; margin: 4px 0 8px 0; color: #ab791a; font-weight: bold;}
    @media (max-width: 700px) {
      .row-flex { flex-direction: column; align-items: flex-start; }
      img { margin-bottom: 12px; }
      .btn-col { gap:18px;}
      .add-space-btn-wrap { width: 100%; }
      .add-space-btn { width: 100%; max-width: 100%; }
    }
  </style>
</head>
<body>
  <div class="card">
    <h2>ğŸ  ç©ºé–“è¨­è¨ˆå°è¦½æ–‡æ¡ˆå°å¹«æ‰‹</h2>

    <div class="row-flex">
      <div>
        <label>ğŸ“· ä¸Šå‚³2Då¹³é¢åœ–ï¼ˆJPG / PNGï¼‰</label>
        <input type="file" id="floorplan" accept="image/png, image/jpeg" onchange="previewImage(event)">
        <img id="preview" style="max-height: 120px; object-fit: contain; display:block;" />
      </div>
    </div>
    <div style="margin-bottom: 18px;">
      <label>ğŸ“ ç¸½åªæ•¸ï¼ˆå¯æ‰‹å‹•è¼¸å…¥æˆ–AIè‡ªå‹•ä¼°ç®—ï¼‰</label>
      <input type="number" id="total_area" placeholder="AIè‡ªå‹•ä¼°ç®—" style="max-width:140px; display:inline-block;">
      <span id="areaPreview" style="color:#7b5; font-size:15px; margin-left: 15px;"></span>
      <span id="assignTip" style="color:#ab791a; font-size:13px;"></span>
    </div>

    <label>ğŸ¨ è¨­è¨ˆé¢¨æ ¼</label>
    <select id="style" onchange="updateStyleInfo(this.value)">
      <option value="">è«‹é¸æ“‡é¢¨æ ¼</option>
      <option value="åŒ—æ­é¢¨">åŒ—æ­é¢¨</option><option value="æ—¥å¼ç¦ªé¢¨">æ—¥å¼ç¦ªé¢¨</option><option value="å·¥æ¥­é¢¨">å·¥æ¥­é¢¨</option>
      <option value="ç°¡ç´„é¢¨">ç°¡ç´„é¢¨</option><option value="æ··æ­é¢¨">æ··æ­é¢¨</option><option value="ç¾ä»£é¢¨">ç¾ä»£é¢¨</option>
      <option value="é„‰æ‘é¢¨">é„‰æ‘é¢¨</option><option value="å¤å…¸é¢¨">å¤å…¸é¢¨</option><option value="æ–°å¤å…¸é¢¨">æ–°å¤å…¸é¢¨</option>
      <option value="ç¾å¼é¢¨">ç¾å¼é¢¨</option><option value="åœ°ä¸­æµ·é¢¨">åœ°ä¸­æµ·é¢¨</option><option value="æ—¥å¼ç„¡å°é¢¨">æ—¥å¼ç„¡å°é¢¨</option>
      <option value="æ—¥å¼ä¾˜å¯‚é¢¨">æ—¥å¼ä¾˜å¯‚é¢¨</option>
    </select>
    <div id="style_feature" class="preview-block">é¢¨æ ¼ç‰¹è‰²ï¼šè«‹é¸æ“‡è¨­è¨ˆé¢¨æ ¼</div>

    <label>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å±…ä½æˆå“¡</label>
    <input id="member" placeholder="ä¾‹å¦‚ï¼šå¤«å¦»ï¼‹åœ‹å°å¥³å…’ï¼‹ç°è²“">
    <label>ğŸ’¼ è·æ¥­</label>
    <input id="job" placeholder="ä¾‹å¦‚ï¼šå¤«å¦»çš†ç‚ºå…¬å‹™å“¡">
    <label>ğŸ¯ èˆˆè¶£èˆ‡ç”Ÿæ´»ç¿’æ…£</label>
    <input id="hobby" placeholder="ä¾‹å¦‚ï¼šæ‰“ç¾½æ¯›çƒã€çœ‹å½±é›†ã€æ”¶è—å…¬ä»”">
    <label>ğŸ“¦ ç©ºé–“ä¸»è¦éœ€æ±‚</label>
    <input id="need" placeholder="ä¾‹å¦‚ï¼šå¤§é‡æ”¶ç´ã€å¯µç‰©å…±å±…ã€é–±è®€ç©ºé–“">

    <button onclick="analyzeFurniture()">ğŸ“Š åˆ†æç©ºé–“èˆ‡å®¶å…·é…ç½®</button>
    <p id="status"></p>
    <div id="furniturePreview" class="preview-block"></div>

    <div style="font-weight:bold; margin:10px 0 5px 0;">
      <span id="showTotalArea" style="color:#c18801;"></span>
    </div>

    <div class="btn-col">
      <div class="add-space-btn-wrap">
        <button class="add-space-btn" onclick="addSpace()">â• æ–°å¢ç©ºé–“</button>
      </div>
      <div>
        <div class="desc-tips">ç¢ºèªä¸Šæ–¹ç©ºé–“èˆ‡å‚¢ä¿±é…ç½®å¾Œè«‹æŒ‰ã€Œåˆ†æ®µç”¢å‡ºå®Œæ•´å°è¦½æ–‡æ¡ˆã€éˆ•ï¼Œå³å¯ç«‹å³ç”¢å‡ºæ–‡æ¡ˆã€‚</div>
        <button onclick="generateAllSections()">ğŸ“ åˆ†æ®µç”¢å‡ºå®Œæ•´å°è¦½æ–‡æ¡ˆ</button>
      </div>
    </div>

    <div id="docPreview" class="preview-block">ğŸ“ æ–‡æ¡ˆé è¦½å€å°‡é¡¯ç¤ºæ–¼æ­¤</div>
    <button id="downloadWord" onclick="downloadWordDoc()" style="display:none;">ğŸ“„ ä¸‹è¼‰ Word æ–‡æ¡ˆ</button>
  </div>
  <script>
    const styleFeatureMap = {
      "åŒ—æ­é¢¨": "æ¸…æ–°è‡ªç„¶ç°¡ç´„", "æ—¥å¼ç¦ªé¢¨": "éœè¬ç•™ç™½ç¦ªæ„", "å·¥æ¥­é¢¨": "ç²—ç·æ°´æ³¥é‡‘å±¬",
      "ç°¡ç´„é¢¨": "ç·šæ¢æ¸…çˆ½å¯¦ç”¨", "æ··æ­é¢¨": "ç•°æè‡ªç”±çµ„åˆ", "ç¾ä»£é¢¨": "ä¿è½ç§‘æŠ€è³ªæ„Ÿ",
      "é„‰æ‘é¢¨": "æº«é¦¨è‡ªç„¶æœ¨è³ª", "å¤å…¸é¢¨": "å°ç¨±é›•é£¾å±¤æ¬¡", "æ–°å¤å…¸é¢¨": "å„ªé›…ç¾ä»£èåˆ",
      "ç¾å¼é¢¨": "èˆ’é©å¤§å™¨å±…å®¶", "åœ°ä¸­æµ·é¢¨": "è—ç™½æ‹±é–€æ›²ç·š", "æ—¥å¼ç„¡å°é¢¨": "æ¨¸ç´ æº«æ½¤æœ¨è‰²",
      "æ—¥å¼ä¾˜å¯‚é¢¨": "ç°èª¿ç•™ç™½æ™‚é–“æ„Ÿ"
    };

    function updateStyleInfo(style) {
      document.getElementById("style_feature").textContent = "é¢¨æ ¼ç‰¹è‰²ï¼š" + (styleFeatureMap[style] || "è«‹é¸æ“‡è¨­è¨ˆé¢¨æ ¼");
    }

    function previewImage(event) {
      const reader = new FileReader();
      reader.onload = function(){
        document.getElementById("preview").src = reader.result;
      };
      reader.readAsDataURL(event.target.files[0]);
    }

    document.addEventListener('DOMContentLoaded', function(){
      document.getElementById("total_area").addEventListener('input', function(){
        let total = parseFloat(this.value);
        let tip = document.getElementById('assignTip');
        if (total && window.latestParsedFurniture && window.latestParsedFurniture.length > 0) {
          let oldSum = window.latestParsedFurniture.reduce((sum, s) => sum + (parseFloat(s.area) || 0), 0);
          if (oldSum > 0) {
            window.latestParsedFurniture.forEach(s => {
              s.area = Math.round((parseFloat(s.area) || 0) / oldSum * total * 10) / 10;
            });
            renderFurnitureTable(window.latestParsedFurniture);
            tip.innerText = "å„ç©ºé–“åªæ•¸å·²è‡ªå‹•æŒ‰æ¯”ä¾‹åˆ†é…ï¼Œå¯æ‰‹å‹•å¾®èª¿ã€‚";
          }
        } else {
          tip.innerText = "";
        }
        calcAndDisplayTotalArea();
      });
    });

    function calcAndDisplayTotalArea() {
      let total = 0;
      if (window.latestParsedFurniture && window.latestParsedFurniture.length) {
        total = window.latestParsedFurniture.reduce((sum, s) => sum + (parseFloat(s.area) || 0), 0);
      }
      document.getElementById("showTotalArea").innerText = "ç©ºé–“ç¸½åªæ•¸ï¼š" + (total || '') + " åª";
    }

    // ğŸŸ¢ã€é‡é»ä¿®æ­£ã€‘åˆ†ææ™‚é€å‡º user_total_area çµ¦å¾Œç«¯
    async function analyzeFurniture() {
      const fileInput = document.getElementById("floorplan");
      const status = document.getElementById("status");
      const furniturePreview = document.getElementById("furniturePreview");
      const userTotalArea = document.getElementById("total_area").value;

      if (!fileInput.files.length) {
        status.textContent = "è«‹å…ˆä¸Šå‚³åœ–é¢";
        return;
      }

      status.textContent = "ğŸ“¤ æ­£åœ¨åˆ†æåœ–é¢...";
      const formData = new FormData();
      formData.append("file", fileInput.files[0]);
      if (userTotalArea) {
        formData.append("user_total_area", userTotalArea);
      }

      const parseRes = await fetch("https://interior-indoortour-ai.onrender.com/api/parse_floorplan", { method: "POST", body: formData });
      const parsed = await parseRes.json();
      window.latestParsedFurniture = parsed.spaces;
      window.latestTotalArea = parsed.total_area;

      if (!document.getElementById("total_area").value && parsed.total_area) {
        document.getElementById("total_area").value = parsed.total_area;
      }
      renderFurnitureTable(parsed.spaces);
      calcAndDisplayTotalArea();
      document.getElementById('assignTip').innerText = '';
      status.textContent = "âœ… åˆ†æå®Œæˆï¼Œè«‹ç¹¼çºŒç”¢å‡ºå°è¦½æ–‡æ¡ˆã€‚";
    }

    function renderFurnitureTable(spaces) {
      let tableHtml = "<h3>ğŸ“‹ å®¶å…·é…ç½®é è¦½ï¼ˆå¯ç›´æ¥é»æ“Šç·¨è¼¯ï¼‰</h3><table border='1' cellpadding='6' style='border-collapse:collapse; width:100%; text-align:left;'><thead><tr><th>ç©ºé–“åç¨±</th><th>åªæ•¸</th><th>ä¸»è¦å®¶å…·é…ç½®</th><th>æ“ä½œ</th></tr></thead><tbody>";
      spaces.forEach((space, i) => {
        tableHtml += `<tr>
          <td><input value="${space.name}" onchange="editSpace(${i}, 'name', this.value)"></td>
          <td><input value="${space.area}" style="width:60px;" onchange="editSpace(${i}, 'area', this.value)"></td>
          <td><input value="${Array.isArray(space.furniture) ? space.furniture.join('ã€') : ''}" onchange="editSpace(${i}, 'furniture', this.value)"></td>
          <td><button class="table-edit-btn" onclick="deleteSpace(${i})">åˆªé™¤</button></td>
        </tr>`;
      });
      tableHtml += `</tbody></table>`;
      document.getElementById("furniturePreview").innerHTML = tableHtml;
    }

    function editSpace(i, key, value) {
      if (key === "furniture") {
        window.latestParsedFurniture[i][key] = value.split("ã€").map(f => f.trim()).filter(f=>f);
      } else if (key === "area") {
        window.latestParsedFurniture[i][key] = parseFloat(value);
        calcAndDisplayTotalArea();
      } else {
        window.latestParsedFurniture[i][key] = value;
      }
    }
    function deleteSpace(i) {
      window.latestParsedFurniture.splice(i, 1);
      renderFurnitureTable(window.latestParsedFurniture);
      calcAndDisplayTotalArea();
    }
    function addSpace() {
      if (!window.latestParsedFurniture) window.latestParsedFurniture = [];
      window.latestParsedFurniture.push({ name: "æ–°ç©ºé–“", area: 0, furniture: [] });
      renderFurnitureTable(window.latestParsedFurniture);
      calcAndDisplayTotalArea();
    }

    window.generatedSections = {};
    // ğŸŸ¢ã€åˆ†æ®µç”¢æ–‡æ¡ˆã€‘roomså€å¡Šé€å€è«‹æ±‚
    async function generateAllSections() {
      const fileInput = document.getElementById("floorplan");
      if (!fileInput.files.length) { alert("è«‹ä¸Šå‚³åœ–é¢"); return; }

      let areaSum = 0;
      if (window.latestParsedFurniture && window.latestParsedFurniture.length) {
        areaSum = window.latestParsedFurniture.reduce((sum, s) => sum + (parseFloat(s.area) || 0), 0);
      }
      document.getElementById("areaPreview").innerText = "";
      document.getElementById("showTotalArea").innerText = "ç©ºé–“ç¸½åªæ•¸ï¼š" + (areaSum || '') + " åª";

      const payload = {
        total_area: areaSum,
        style: document.getElementById("style").value,
        owner_info:
          "å±…ä½æˆå“¡ï¼š" + document.getElementById("member").value + "\n" +
          "è·æ¥­ï¼š" + document.getElementById("job").value + "\n" +
          "èˆˆè¶£ï¼š" + document.getElementById("hobby").value + "\n" +
          "éœ€æ±‚ï¼š" + document.getElementById("need").value,
        furniture_layout: window.latestParsedFurniture,
        image_filename: fileInput.files[0].name
      };

      let sectionNames = {
        concept: "ææ¡ˆå‘½åèˆ‡è¨­è¨ˆç†å¿µç¸½è¿°",
        overview: "ç©ºé–“ç¸½è¦½èˆ‡å‹•ç·šèªªæ˜",
        rooms: "é€å€ç©ºé–“å°è¦½",
        owner_story: "å±‹ä¸»æ•…äº‹",
        conclusion: "ç©ºé–“çµèª"
      };

      document.getElementById("docPreview").innerText = "â³ ç”¢ç”Ÿä¸­...";

      // 1. å…ˆç”¢å‡ºå…¶ä»–å€å¡Šï¼ˆéroomsï¼‰
      let sections = {};
      for (const section of ["concept", "overview", "owner_story", "conclusion"]) {
        const res = await fetch("https://interior-indoortour-ai.onrender.com/api/generate_section", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ...payload, section })
        });
        const data = await res.json();
        sections[section] = data.content || "";
        let preview = "";
        for (const sec of ["concept", "overview"]) {
          if (sections[sec]) {
            preview += `ã€${sectionNames[sec]}ã€‘\n${sections[sec]}\n\n`;
          }
        }
        document.getElementById("docPreview").innerText = preview.trim() + "\nâ³ é€å€ç©ºé–“å°è¦½ç”¢ç”Ÿä¸­...";
      }

      // 2. é€å€åˆ†æ®µè«‹æ±‚
      let roomTexts = [];
      let spaces = window.latestParsedFurniture || [];
      for (let i = 0; i < spaces.length; i++) {
        const space = spaces[i];
        // å°æ¯å€ç™¼è«‹æ±‚
        const roomPayload = {
          ...payload,
          section: "room",
          room_data: space,
        };
        document.getElementById("docPreview").innerText += `\nâ³ ç”¢ç”Ÿä¸­: ${space.name}...`;
        const res = await fetch("https://interior-indoortour-ai.onrender.com/api/generate_section", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(roomPayload)
        });
        const data = await res.json();
        roomTexts.push(`ã€${space.name}ã€‘\n${data.content}`);
        // å³æ™‚åˆ·æ–°
        document.getElementById("docPreview").innerText =
          `${["concept","overview"].map(sec => sections[sec] ? `ã€${sectionNames[sec]}ã€‘\n${sections[sec]}` : "").join("\n\n")}\n\n` +
          `ã€é€å€ç©ºé–“å°è¦½ã€‘\n${roomTexts.join('\n\n')}\n\n` +
          `${["owner_story","conclusion"].map(sec => sections[sec] ? `ã€${sectionNames[sec]}ã€‘\n${sections[sec]}` : "").join("\n\n")}`;
      }

      // çµ„åˆçµæœ
      document.getElementById("docPreview").innerText =
        `${["concept","overview"].map(sec => sections[sec] ? `ã€${sectionNames[sec]}ã€‘\n${sections[sec]}` : "").join("\n\n")}\n\n` +
        `ã€é€å€ç©ºé–“å°è¦½ã€‘\n${roomTexts.join('\n\n')}\n\n` +
        `${["owner_story","conclusion"].map(sec => sections[sec] ? `ã€${sectionNames[sec]}ã€‘\n${sections[sec]}` : "").join("\n\n")}`;

      window.generatedSections = {
        ...sections,
        rooms: roomTexts.join('\n\n')
      };
      document.getElementById("downloadWord").style.display = "inline-block";
    }

    async function downloadWordDoc() {
      const fileInput = document.getElementById("floorplan");
      let areaSum = 0;
      if (window.latestParsedFurniture && window.latestParsedFurniture.length) {
        areaSum = window.latestParsedFurniture.reduce((sum, s) => sum + (parseFloat(s.area) || 0), 0);
      }
      const payload = {
        ...window.generatedSections,
        total_area: areaSum,
        image_filename: fileInput.files[0].name
      };
      const docRes = await fetch("https://interior-indoortour-ai.onrender.com/api/download_word_docx", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const blob = await docRes.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "ç©ºé–“è¨­è¨ˆå°è¦½æ–‡æ¡ˆ.docx";
      a.click();
    }
  </script>
</body>
</html>
